{"componentChunkName":"component---src-templates-blog-post-js","path":"/trabalhando-com-monorepo-em-javascript/","result":{"data":{"site":{"siteMetadata":{"title":"Blog | Vitor Freitas"}},"markdownRemark":{"id":"3d6a94bc-1486-54b5-99f2-ec0c5dec6566","excerpt":"Já ouviu falar do termo Monorepo? Ou Multirepo? São termos utilizados para definir dois modelos arquiteturais, onde resumidamente são formas de definirmos se…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 581px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1c6cc23e23443601a17f652910f4f952/92d15/monorepo-multirepo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.27027027027026%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAB80lEQVQ4y3VT227TQBD1//8MCCGBUCoVKipxechDENAmTm0H7DjxJfF1bceHOVvvNqnKSCN7dmbOzJzZdZIkQdM0qKoKbdui73ut5uxc67pG13VWaZ/78zyHw0QjWZZhuVxivV6jKks8l3EctW+z2cD3fZxOpws/sRwiUwYJLgUkiiL8DUMcivIikEq/53laCXw8HvU5O1VK6a9Ty4EqCxT7GHtR3Ukv46R7xHEkCbVOIh0E5Nd0S5s6DIMd3ylVh/buB3bXb/Hp5h1qqdQED8hmr3H7+QPSZIdGQMwk7ISgBCAo+abdTjGOadmXMeI41kF0Br6HUEY/X5BZhDkj+Pn3EZCbO40IwgiHw9HyGURbpGlmCzBhPp/rIhSCLxYLuK6rbTtyxXZ3W5SBi4f1PZQEtnmG2lsJ+SuUxdGOZKbhdk1XtMmh7ZAcKvcO+9sZvny9RtP1UOEf5Dfv8f3bR+RZaoN19xNnBKIQ3CztiUMBXXm+bDl5JF5A3WAjV2hrExicpSlyoeWkR+71tTkc8gueHT2CtMzgcrrMBKFdFIX+Z3Ulei+XPomEw6qQ4lv8/vXTcvrE4TTK+Wt4brPQaF7FLsT+6g2uZq/Qd2pqYLDPzwIy0YCZf2OzuumgboQr/TI6OyZ9htcLwJfe7kvn/xMC/gPVnjfU5d0XrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Multirepo vs Monorepo\"\n        title=\"Multirepo vs Monorepo\"\n        src=\"/static/1c6cc23e23443601a17f652910f4f952/92d15/monorepo-multirepo.png\"\n        srcset=\"/static/1c6cc23e23443601a17f652910f4f952/12f09/monorepo-multirepo.png 148w,\n/static/1c6cc23e23443601a17f652910f4f952/e4a3f/monorepo-multirepo.png 295w,\n/static/1c6cc23e23443601a17f652910f4f952/92d15/monorepo-multirepo.png 581w\"\n        sizes=\"(max-width: 581px) 100vw, 581px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Já ouviu falar do termo Monorepo? Ou Multirepo? São termos utilizados para definir dois modelos arquiteturais, onde resumidamente são formas de definirmos se iremos manter nosso código de vários projetos em apenas um repositório versionado (git) ou em vários repositórios onde cada projeto terá o seu por exemplo.</p>\n<p>Nesse post vamos falar sobre como criar o seu monorepo utilizando Javascript, não muito sobre quais são os casos indicados de cada arquitetura, ou seus prós e contras, porém vou deixar aqui uma comparação simples das duas abordagens:</p>\n<h2>Multirepo</h2>\n<ul>\n<li>Vários repositórios, normalmente 1 por projeto.</li>\n<li>Cada projeto tem o seu processo de deploy separado, com testes automatizados e builds apenas daquele projeto, sendo então mais rápidos e previsíveis.</li>\n<li>Cada repositório tem as suas dependências com suas versões e é independente, porém normalmente isso leva a duplicidade de dependências, ou a conflito de versões.</li>\n<li>Os times possuem mais autonomia, podendo realizar mudanças em seu repositório sem envolver outros times.</li>\n</ul>\n<h2>Monorepo</h2>\n<ul>\n<li>Um repositório para vários projetos e times.</li>\n<li>Como temos um repositório só é “mais simples” para novos membros se situarem.</li>\n<li>Os times tem menos autonomia, já que qualquer mudança pode impactar outros projetos, e boa parte das alterações devem ser alinhadas e planejadas entre os times.</li>\n<li>As dependências dos projetos são unificadas e centralizadas, fazendo com que todos os projetos respeitem uma mesma versão de uma dependência X, assim gerando menos conflitos e duplicamento de dependências.</li>\n</ul>\n<p>Tem vários outros pontos a se levar em conta na hora de escolher qual caminho deve ser tomado na sua empresa/projeto, lembre-se, não existe bala de prata ;), mas realizar uma escolha que faça sentido com a cultura da empresa, e dos times envolvidos, com certeza trará mais benefícios.</p>\n<p>Agora vamos para a prática ;)</p>\n<h2>Início do projeto</h2>\n<p>Para começar vamos criar um novo projeto, que será um monorepo e que terá a princípio duas bibliotecas. Para isso vamos utilizar duas ferramentas importantes, o <a href=\"https://lerna.js.org/\">Lerna</a> e o <a href=\"https://classic.yarnpkg.com/en/docs/workspaces/\">Yarn Workspaces</a>. Cada uma delas tem o seu papel em nos fornecer funcionalidades para nos ajudar a gerenciar nosso monorepo, por isso devem ser usadas em conjunto, já que <em>uma não substitui a outra</em>.</p>\n<p>Vamos falar um pouco dos dois antes de partir pro código:</p>\n<h3>Yarn Workspaces</h3>\n<p>O Yarn é um gerenciador de dependências assim como o npm, e possui a funcionalidade de workspaces que nos permite gerenciar repositórios que são monorepos. Basicamente o Yarn Workspaces fica responsável por gerenciar as dependências do projeto e fazer a distinção de quais dependências são utilizadas por qual projeto dentro do monorepo, e quais são globais e servem para o projeto como um todo. Cuidando então da parte mais de “baixo” de um monorepo.</p>\n<blockquote>\n<p>A funcionalidade de workspaces do Yarn, também está sendo criada pelo time do NPM, e vai estar disponível no <a href=\"https://blog.npmjs.org/post/617484925547986944/npm-v7-series-introduction\">NPM@7.0.0</a>. Depois que ele for lançado irei atualizar esse artigo ou criar um novo comparando com o Yarn no uso com monorepos.</p>\n</blockquote>\n<h3>Lerna</h3>\n<p>Já o Lerna é uma ferramenta que cuida da parte mais de “cima” de um monorepo, trazendo facilidades ao gerenciar um monorepo, e quando utilizado em conjunto com o Yarn Workspaces, ele deixa todo o trabalho de gerenciamento de dependências com o Yarn, e cuida mais da parte de execução de comandos, e publicação desses pacotes, assim como gerenciando a versão (utilizando <a href=\"https://semver.org/\">semver</a>) de cada projeto, seja com uma versão única para todos, ou diferente.</p>\n<p>Agora para começar vamos instalar os dois:</p>\n<blockquote>\n<p>O Yarn possui seus próprios métodos de <a href=\"https://classic.yarnpkg.com/en/docs/install\">instalação dependendo do sistema operacional</a>\nPara manter a simplicidade iremos instalar da forma mais simples, apesar de <a href=\"https://classic.yarnpkg.com/en/docs/install/#alternatives-stable\">não recomendada pelo Yarn</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g <span class=\"token function\">yarn</span>\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g lerna</code></pre></div>\n<p>Depois podemos criar nosso projeto usando a CLI do Lerna:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ lerna init</code></pre></div>\n<p>Agora precisamos integrar o Yarn Workspaces com o Lerna, para isso precisamos adicionar duas configurações, e configurar o <code class=\"language-text\">package.json</code> das nossas duas bibliotecas!</p>\n<p>package.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token property\">\"private\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// E dizemos pro Yarn que esse package.json princípal, é privado, e não deve ser publicado</span>\n  <span class=\"token property\">\"workspaces\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Adicionamos essa entrada mapeando o mesmo caminho de packages que já veio</span>\n    <span class=\"token property\">\"packages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token comment\">// configurado pelo Lerna. Essa entrada é para avisar o Yarn workspaces, quais são os </span>\n      <span class=\"token string\">\"packages/**\"</span> <span class=\"token comment\">// seus workspaces</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>lerna.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"npmClient\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"yarn\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Indicamos ao Lerna que estamos usando o yarn invés do npm</span>\n  <span class=\"token property\">\"useWorkspaces\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// E dizemos que o workspaces do yarn esta habilitado</span>\n  <span class=\"token property\">\"packages\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"packages/*\"</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.0.0\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>E depois criamos dois <code class=\"language-text\">packages</code> que serão nossas bibliotecas, e adicionamos um <code class=\"language-text\">package.json</code> para cada:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5d7a4324926042ce2ebf6449e13f53ce/8c557/packages-novos.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVUlEQVQoz42S6XaCMBCFfYzKlgRkDYsQCKjVbvZ0+eH7v83tgKitp9j+uCdhknxzZ5hZLDv4fgmvasA2GmytIaoa3mIJzx91tQ9ChUTqQXHSIKTvoNAIYoVZGGv4bg6+ajD/bDE/dLC6Cpyn4C5J/CYJxi/iTMJKcjh0fwC6boYoVTD2Dey1AvcyCCeFIKgQtHf/ECVx5BJ8kWEWEVAQuVpGcDaKXHYwen20MJ+aI7x3NQEa4pTYyUdg79CjR4GsYbxqWI8NrId6uHjSFPB8TkBbFmDe6JBTWXlGwZ2C+UzQXQ27LuGU5b+BTnp22MIPEmSKgFvq41sL470dXNordRP4o+RiBAYELNKQRobc3ddHUF3BNRIIW14e0XrTYXYFFNsKd4fVMDbmXsN8oVYE+RnIJ/7wEGdUHbWH+X0Pk5YOyE2Yg/VKqLkRzaWf3y73O/CUlNYvcNUlxPXcassAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Imagem das duas bibliotecas novas\"\n        title=\"Imagem das duas bibliotecas novas\"\n        src=\"/static/5d7a4324926042ce2ebf6449e13f53ce/fcda8/packages-novos.png\"\n        srcset=\"/static/5d7a4324926042ce2ebf6449e13f53ce/12f09/packages-novos.png 148w,\n/static/5d7a4324926042ce2ebf6449e13f53ce/e4a3f/packages-novos.png 295w,\n/static/5d7a4324926042ce2ebf6449e13f53ce/fcda8/packages-novos.png 590w,\n/static/5d7a4324926042ce2ebf6449e13f53ce/8c557/packages-novos.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>packages/log-lib/package.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@my-monorepo/log-lib\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>packages/math-lib/package.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@my-monorepo/math-lib\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>E depois rodamos o comando referente ao <code class=\"language-text\">npm install</code> do Yarn, para que ele possa identificar nossos workspaces, e baixar tudo que for preciso.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">yarn</span></code></pre></div>\n<p>Agora se olharmos no <code class=\"language-text\">node_modules</code> do nosso projeto, podemos ver que o Yarn já cuidou de criar as referencias aos nossas duas bibliotecas, e deixar disponível para caso outro projeto dentro do monorepo queira utiliza-lo:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8bd97cad81116ea3552f58969704ebb4/31198/node-modules-com-packages.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABsklEQVQ4y6WU607CQBCFeRAVet/tvaVyqa2lKHIJXglgook/jDG+/wMcZxdJACWU+ONkmt3p1zOz061pegDGEzDnAtzNZLT9ArZ3Cc2IoKg+VO2wFJKmh6gpqgfDDMHsLsEy6GYTJmvDYC2Z1FDcylK1YAXUhUu7Qw5zuSgTGo6MYr+KJFBfAw0COl0qtYQTlLIEAVwnHg00CMjdlGB96dKLBrB49x8O6YE7KR1EAYt6qVJz16VXdfmrZAEU5QqoZsRbsOOBui97yOTYZOQy/QXaB9388LZD6qGYPyacUhRuvXggyz8E2wGuBpPxNkw7l6orAU5OOU7PbEqscCj0vmElK2CdxkO8aDETcZIizUZotXtIkhxNkqK6OKtzkv0T/5JNDC7htSDqIYz76KQFbu8XWCzf8fL6iendC8aTZzTPrxFGpcwJ43JHq7WIYqszhOvnqGXFI3pXSwxGr1g8f2G+/MTT/ANp/ohu9oDLco6ivyDN96pH++PpG0HH1ENNNNSH51vI8xyTyQzT2xmGowcMbu7oP48qjY1o3c4pd+CGBfyoj4DKMK0I4ibanMUql8M3+kzFlgEaNHYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Nossas bibliotecas na node_modules\"\n        title=\"Nossas bibliotecas na node_modules\"\n        src=\"/static/8bd97cad81116ea3552f58969704ebb4/fcda8/node-modules-com-packages.png\"\n        srcset=\"/static/8bd97cad81116ea3552f58969704ebb4/12f09/node-modules-com-packages.png 148w,\n/static/8bd97cad81116ea3552f58969704ebb4/e4a3f/node-modules-com-packages.png 295w,\n/static/8bd97cad81116ea3552f58969704ebb4/fcda8/node-modules-com-packages.png 590w,\n/static/8bd97cad81116ea3552f58969704ebb4/31198/node-modules-com-packages.png 694w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Publicando nossos pacotes</h2>\n<p>Agora vamos ver como publicar nossos pacotes e testa-los localmente, e depois como publica-los diretamente no NPM ou em algum outro registro privado (comum em grandes empresas).</p>\n<p>Para publicar nossos pacotes localmente vamos utilizar o <a href=\"https://verdaccio.org/docs/en/installation\">Verdaccio</a> que é um registro privado feito com NodeJs, de fácil configuração e que nos permite adicionar ou buscar pacotes pelo NPM, da mesma forma que buscamos e adicionamos pacotes no próprio registro do NPM.</p>\n<blockquote>\n<p><em>O que é um registro?</em> É basicamente um repositório de pacotes/bibliotecas que possui uma API para buscar/adicionar pacotes, é compatível com o <a href=\"https://semver.org/\">semver</a></p>\n</blockquote>\n<h2>Por hoje é só</h2>\n<p>Na parte 2 falaremos sobre como criar um processo automatizado de deploy (CI/CD) para o nosso monorepo, de forma que a gente possa publicar automaticamente nossas bibliotecas no npm (ou outro registro) depois de cada commit/pull request na master ;)</p>\n<p>Obrigado por ler!</p>","timeToRead":5,"frontmatter":{"title":"Trabalhando com Monorepo em Javascript","date":"17 setembro, 2020","description":"Configurando Lerna e Yarn workspaces"}}},"pageContext":{"slug":"/trabalhando-com-monorepo-em-javascript/","previous":null,"next":null}},"staticQueryHashes":["2219013263","2841359383"]}